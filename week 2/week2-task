import os
import json
import pandas as pd

BASE_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), "../../"))
DATA_DIR = os.path.join(BASE_DIR, "week 1", "data")
OUTPUT_DIR = os.path.join(BASE_DIR, "week 2", "output")
OUTPUT_FILE = os.path.join(OUTPUT_DIR, "parsed_csv.json")

os.makedirs(OUTPUT_DIR, exist_ok=True)

parsed_data = []

for root, dirs, files in os.walk(DATA_DIR):
    for file in files:
        if file.lower().endswith(".csv"):
            file_path = os.path.join(root, file)

            # Department from folder name
            department = os.path.basename(os.path.dirname(file_path))

            try:
                df = pd.read_csv(file_path, encoding="utf-8", errors="ignore")
            except Exception as e:
                print(f"‚ùå Failed to read {file}: {e}")
                continue

            text_rows = []
            for _, row in df.iterrows():
                row_text = "; ".join(
                    f"{col}: {row[col]}" for col in df.columns
                )
                text_rows.append(row_text)

            parsed_data.append({
                "filename": file,
                "filepath": file_path.replace(BASE_DIR, ""),
                "department": department,
                "columns": list(df.columns),
                "row_count": len(df),
                "text_content": text_rows
            })

            print(f"‚úÖ Processed: {file} ({len(df)} rows)")

with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
    json.dump(parsed_data, f, indent=4)

print("\nüéâ All CSV files converted successfully!")
print(f"üìÅ Output saved to: {OUTPUT_FILE}")